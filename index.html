<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海豚记账本 - 专业记账软件</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <style>
        /* 原有样式保持不变，只添加新增的样式 */
        
        /* 记录操作按钮样式 */
        .record-actions {
            display: flex;
            gap: 8px;
        }
        
        .record-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .record-edit-btn {
            background: #667eea;
            color: white;
        }
        
        .record-edit-btn:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }
        
        .record-delete-btn {
            background: #ef4444;
            color: white;
        }
        
        .record-delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        /* 编辑记录模态框样式 */
        .edit-record-form {
            padding: 20px;
        }
        
        .edit-record-form .amount-input {
            display: flex;
            align-items: center;
            font-size: 36px;
            font-weight: 300;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .edit-record-form .amount-input .currency {
            color: #667eea;
            margin-right: 10px;
            font-weight: 500;
        }
        
        .edit-record-form .amount-input input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 36px;
            font-weight: 300;
            color: #2c3e50;
            background: transparent;
        }
        
        /* 确认删除模态框样式 */
        .confirm-delete-content {
            text-align: center;
            padding: 30px 20px;
        }
        
        .confirm-delete-content i {
            font-size: 60px;
            color: #ef4444;
            margin-bottom: 20px;
        }
        
        .confirm-delete-content h4 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1e293b;
        }
        
        .confirm-delete-content p {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 5px;
        }
        
        .confirm-delete-content .record-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
        }
        
        .confirm-delete-content .record-info div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .confirm-delete-content .record-info .label {
            color: #64748b;
        }
        
        .confirm-delete-content .record-info .value {
            color: #334155;
            font-weight: 500;
        }
        
        .confirm-delete-content .warning {
            color: #ef4444;
            font-size: 12px;
            font-weight: 500;
            margin-top: 15px;
        }
        
        /* 分类选择器样式 */
        .category-picker {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .category-picker-title {
            font-size: 14px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 10px;
        }
        
        .category-picker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .category-picker-btn {
            padding: 10px 5px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .category-picker-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .category-picker-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .category-picker-btn i {
            font-size: 20px;
            color: #64748b;
            margin-bottom: 5px;
        }
        
        .category-picker-btn.active i {
            color: #667eea;
        }
        
        .category-picker-btn span {
            font-size: 11px;
            color: #475569;
            font-weight: 500;
        }
        
        /* 按钮组样式 */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button-group button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        /* 以下为原有样式，保持不变... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f8f9fc 0%, #eef2f7 100%);
            color: #2c3e50;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .app-container {
            max-width: 414px;
            margin: 0 auto;
            min-height: 100vh;
            background: #f8f9fc;
            position: relative;
        }

        /* 顶部状态栏 */
        .status-bar {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            padding: 8px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .status-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
        }

        .status-icons i {
            margin-left: 6px;
            font-size: 12px;
        }

        /* 页面内容 */
        .page-content {
            padding: 15px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 当月收支总览 */
        .month-overview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.25);
            position: relative;
            overflow: hidden;
        }

        .month-overview::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
        }

        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 500;
            position: relative;
        }

        .month-subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        .month-stats {
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .stat-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 12px;
            transition: transform 0.3s;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.1);
        }

        .stat-item:not(:last-child) {
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 记账表单 */
        .accounting-form {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .amount-input {
            display: flex;
            align-items: center;
            font-size: 42px;
            font-weight: 300;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .amount-input .currency {
            color: #667eea;
            margin-right: 10px;
            font-weight: 500;
        }

        .amount-input input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 42px;
            font-weight: 300;
            color: #2c3e50;
            background: transparent;
        }

        .amount-input input::placeholder {
            color: #ccc;
        }

        /* 日期选择器 */
        .date-input {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }

        .date-input:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .date-input i {
            color: #667eea;
            margin-right: 10px;
        }

        .date-input input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 16px;
            color: #2c3e50;
        }

        /* 收入支出切换 */
        .type-switcher {
            display: flex;
            background: #f7f8fc;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .type-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .type-btn.active {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .type-btn[data-type="income"] {
            color: #10b981;
        }

        .type-btn[data-type="expense"] {
            color: #ef4444;
        }

        .type-btn.active[data-type="income"] {
            color: #10b981;
            background: #d1fae5;
        }

        .type-btn.active[data-type="expense"] {
            color: #ef4444;
            background: #fee2e2;
        }

        /* 分类选择 */
        .category-selection h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #334155;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .category-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 5px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .category-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .category-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .category-btn.active::after {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 5px;
            color: #667eea;
            font-weight: bold;
            font-size: 12px;
        }

        .category-btn i {
            font-size: 24px;
            color: #64748b;
            margin-bottom: 8px;
            transition: color 0.3s;
        }

        .category-btn.active i {
            color: #667eea;
        }

        .category-btn span {
            font-size: 12px;
            color: #475569;
            font-weight: 500;
        }

        /* 描述输入 */
        .description-input {
            margin-bottom: 20px;
        }

        .description-input input {
            width: 100%;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
            background: #f8fafc;
        }

        .description-input input:focus {
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* 保存按钮 */
        .save-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .save-btn:active {
            transform: translateY(0);
        }

        /* 最近记录 */
        .recent-records h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #334155;
        }

        .recent-list {
            background: white;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .recent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.3s;
        }

        .recent-item:hover {
            background: #f8fafc;
        }

        .recent-item:last-child {
            border-bottom: none;
        }

        .recent-item-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .recent-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f4ff;
        }

        .recent-item-icon i {
            color: #667eea;
            font-size: 18px;
        }

        .recent-item-details h4 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .recent-item-details p {
            font-size: 12px;
            color: #94a3b8;
        }

        .recent-item-amount {
            font-size: 18px;
            font-weight: 600;
        }

        .recent-item-amount.income {
            color: #10b981;
        }

        .recent-item-amount.expense {
            color: #ef4444;
        }

        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 414px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            padding: 8px 0 20px;
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            background: none;
            border: none;
            padding: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #94a3b8;
            transition: all 0.3s;
            border-radius: 8px;
            margin: 0 5px;
        }

        .nav-item.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-item i {
            font-size: 20px;
        }

        .nav-item span {
            font-size: 12px;
            font-weight: 500;
        }

        /* 统计页面 */
        .stats-header, .records-header, .settings-header {
            margin-bottom: 20px;
        }

        .stats-header h2, .records-header h2, .settings-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
        }

        .period-selector {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 14px;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* 自定义日期范围选择器 */
        .custom-date-range {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .custom-date-range.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .custom-date-range .range-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #334155;
        }

        .custom-date-range .date-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .custom-date-range input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .custom-date-range .apply-custom-range {
            width: 100%;
            padding: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        /* 统计概览卡片 */
        .stats-overview {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .overview-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        .overview-card:hover {
            transform: translateY(-5px);
        }

        .overview-label {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .overview-value {
            font-size: 24px;
            font-weight: 600;
        }

        .overview-value.income {
            color: #10b981;
        }

        .overview-value.expense {
            color: #ef4444;
        }

        .overview-value.balance {
            color: #667eea;
        }

        /* 图表容器 */
        .charts-container {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #334155;
        }

        .chart {
            width: 100%;
            height: 250px;
        }

        .chart-large {
            height: 300px;
        }

        /* 分类排行榜 */
        .category-ranking {
            background: white;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .ranking-header {
            padding: 20px 20px 15px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ranking-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .ranking-subtitle {
            font-size: 12px;
            color: #94a3b8;
        }

        /* 新增：排行榜类型切换样式 */
        .ranking-type-switcher {
            display: flex;
            background: #f7f8fc;
            border-radius: 12px;
            padding: 4px;
        }

        .ranking-type-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ranking-type-btn.active {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .ranking-type-btn[data-type="income"] {
            color: #10b981;
        }

        .ranking-type-btn[data-type="expense"] {
            color: #ef4444;
        }

        .ranking-type-btn.active[data-type="income"] {
            color: #10b981;
            background: #d1fae5;
        }

        .ranking-type-btn.active[data-type="expense"] {
            color: #ef4444;
            background: #fee2e2;
        }

        .ranking-list {
            padding: 10px 0;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .ranking-item:hover {
            background: #f8fafc;
            border-left-color: #667eea;
            transform: translateX(5px);
        }

        .ranking-item:hover .ranking-arrow {
            opacity: 1;
            transform: translateX(0);
        }

        .ranking-left {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .ranking-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 15px;
        }

        .ranking-number.top1 {
            background: #ffd700;
            color: white;
        }

        .ranking-number.top2 {
            background: #c0c0c0;
            color: white;
        }

        .ranking-number.top3 {
            background: #cd7f32;
            color: white;
        }

        .ranking-number.normal {
            background: #f1f5f9;
            color: #64748b;
        }

        .ranking-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f4ff;
            margin-right: 15px;
        }

        .ranking-icon i {
            color: #667eea;
            font-size: 18px;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-category {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .ranking-count {
            font-size: 12px;
            color: #94a3b8;
        }

        .ranking-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ranking-amount {
            font-size: 16px;
            font-weight: 600;
        }

        .ranking-amount.income {
            color: #10b981;
        }

        .ranking-amount.expense {
            color: #ef4444;
        }

        .ranking-percentage {
            font-size: 12px;
            color: #94a3b8;
        }

        .ranking-arrow {
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s;
            color: #667eea;
        }

        /* 分类明细模态框 */
        .category-detail-modal .modal-content {
            max-height: 90vh;
        }

        .category-detail-header {
            padding: 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-detail-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-detail-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f4ff;
        }

        .category-detail-icon i {
            color: #667eea;
            font-size: 24px;
        }

        .category-detail-info h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .category-detail-info p {
            font-size: 14px;
            color: #94a3b8;
        }

        .category-detail-summary {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .summary-item {
            flex: 1;
        }

        .summary-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 600;
        }

        .summary-value.income {
            color: #10b981;
        }

        .summary-value.expense {
            color: #ef4444;
        }

        .category-detail-list {
            max-height: 50vh;
            overflow-y: auto;
            padding: 10px 0;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f8fafc;
            transition: background 0.3s;
        }

        .detail-item:hover {
            background: #f8fafc;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-date {
            font-size: 12px;
            color: #94a3b8;
            min-width: 80px;
        }

        .detail-desc {
            font-size: 14px;
            color: #334155;
        }

        .detail-amount {
            font-size: 16px;
            font-weight: 600;
        }

        .detail-amount.income {
            color: #10b981;
        }

        .detail-amount.expense {
            color: #ef4444;
        }

        /* 记录页面 */
        .records-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box {
            flex: 1;
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 15px;
            transition: all 0.3s;
        }

        .search-box:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box i {
            color: #94a3b8;
            margin-right: 10px;
        }

        .search-box input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 16px;
        }

        .filter-btn {
            padding: 10px 15px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* 筛选面板 */
        .filter-panel {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .filter-panel.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .filter-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .filter-row label {
            width: 60px;
            font-size: 14px;
            color: #475569;
        }

        .filter-row select,
        .filter-row input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
            font-size: 14px;
        }

        .filter-row span {
            margin: 0 10px;
            color: #94a3b8;
        }

        .apply-filter-btn {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .apply-filter-btn:hover {
            background: #5a67d8;
        }

        /* 记录列表 */
        .records-list {
            display: grid;
            gap: 10px;
        }

        .record-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .record-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .record-main {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .record-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f4ff;
        }

        .record-icon i {
            color: #667eea;
            font-size: 18px;
        }

        .record-info h4 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .record-meta {
            display: flex;
            gap: 10px;
            font-size: 12px;
            color: #94a3b8;
        }

        .record-amount {
            font-size: 18px;
            font-weight: 600;
            margin-right: 15px;
        }

        .record-amount.income {
            color: #10b981;
        }

        .record-amount.expense {
            color: #ef4444;
        }

        .load-more-btn {
            width: 100%;
            padding: 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 500;
            color: #667eea;
            transition: all 0.3s;
        }

        .load-more-btn:hover {
            background: #667eea;
            color: white;
        }

        /* 设置页面 */
        .settings-section {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .settings-section h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-info .settings-title {
            font-weight: 500;
            margin-bottom: 4px;
            color: #1e293b;
        }

        .settings-info .settings-desc {
            font-size: 12px;
            color: #94a3b8;
        }

        .settings-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .settings-btn.danger {
            background: #ef4444;
        }

        .settings-btn.danger:hover {
            background: #dc2626;
        }

        .settings-btn.success {
            background: #10b981;
        }

        .settings-btn.success:hover {
            background: #059669;
        }

        .settings-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }

        /* 模态框 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #94a3b8;
            padding: 5px;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #f1f5f9;
            display: flex;
            gap: 10px;
        }

        .btn-secondary, .btn-primary {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-secondary {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-primary {
            background: #667eea;
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        /* 导出选项 */
        .export-options {
            display: grid;
            gap: 15px;
        }

        .export-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .export-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .export-option input[type="radio"] {
            margin-right: 12px;
        }

        .export-option i {
            font-size: 24px;
            margin-right: 12px;
            color: #667eea;
        }

        .export-option .option-content {
            flex: 1;
        }

        .export-option .option-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .export-option .option-desc {
            font-size: 12px;
            color: #94a3b8;
        }

        /* 导入区域 */
        .import-area {
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
        }

        .import-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .import-area i {
            font-size: 48px;
            color: #94a3b8;
            margin-bottom: 15px;
        }

        .import-area p {
            color: #64748b;
            margin-bottom: 15px;
        }

        .import-btn {
            padding: 10px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        #importFileInput {
            display: none;
        }

        /* 提示消息 */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            display: none;
            z-index: 1000;
            font-size: 16px;
            animation: toastFade 0.3s ease;
        }

        .toast.show {
            display: block;
        }

        @keyframes toastFade {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* 加载动画 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #667eea;
            font-weight: 500;
        }

        /* 分类管理样式 */
        .category-manage-list {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .category-item.system {
            opacity: 0.6;
        }

        .category-item-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid #e2e8f0;
        }

        .category-item-icon i {
            font-size: 18px;
            color: #667eea;
        }

        .category-item-details h4 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .category-item-details p {
            font-size: 12px;
            color: #94a3b8;
        }

        .delete-category-btn {
            padding: 8px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .delete-category-btn:hover {
            background: #dc2626;
        }

        .delete-category-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .add-category-form {
            display: grid;
            gap: 15px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .form-row {
            display: grid;
            gap: 8px;
        }

        .form-row label {
            font-size: 14px;
            font-weight: 500;
            color: #475569;
        }

        .form-row input, .form-row select {
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .icon-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        .icon-option {
            aspect-ratio: 1;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .icon-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .icon-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .icon-option i {
            font-size: 20px;
        }

        .add-category-btn {
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .add-category-btn:hover {
            background: #5a67d8;
        }

        .add-category-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .tab-switcher {
            display: flex;
            background: #f7f8fc;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tab-btn[data-tab="income"] {
            color: #10b981;
        }

        .tab-btn[data-tab="expense"] {
            color: #ef4444;
        }

        .tab-btn.active[data-tab="income"] {
            color: #10b981;
            background: #d1fae5;
        }

        .tab-btn.active[data-tab="expense"] {
            color: #ef4444;
            background: #fee2e2;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 顶部状态栏 -->
        <div class="status-bar">
            <div class="status-content">
                <span class="time" id="currentTime">9:41</span>
                <div class="status-icons">
                    <i class="fas fa-signal"></i>
                    <i class="fas fa-wifi"></i>
                    <i class="fas fa-battery-full"></i>
                </div>
            </div>
        </div>

        <!-- 页面内容 -->
        <div class="page-content">
            <!-- 记账页面 -->
            <div id="accountingPage" class="page active">
                <div class="month-overview">
                    <div class="month-header">
                        <span id="currentMonth">2025年1月</span>
                        <span class="month-subtitle">本月收支</span>
                    </div>
                    <div class="month-stats">
                        <div class="stat-item income">
                            <div class="stat-label">收入</div>
                            <div class="stat-value" id="monthIncome">¥0</div>
                        </div>
                        <div class="stat-item expense">
                            <div class="stat-label">支出</div>
                            <div class="stat-value" id="monthExpense">¥0</div>
                        </div>
                    </div>
                </div>

                <div class="accounting-form">
                    <div class="amount-input">
                        <span class="currency">¥</span>
                        <input type="number" id="amountInput" placeholder="0.00" step="0.01" min="0">
                    </div>

                    <!-- 日期选择器 -->
                    <div class="date-input">
                        <i class="fas fa-calendar-alt"></i>
                        <input type="date" id="dateInput" value="">
                    </div>

                    <div class="type-switcher">
                        <button class="type-btn" data-type="income">
                            <i class="fas fa-arrow-up"></i>
                            <span>收入</span>
                        </button>
                        <button class="type-btn active" data-type="expense">
                            <i class="fas fa-arrow-down"></i>
                            <span>支出</span>
                        </button>
                    </div>

                    <div class="category-selection">
                        <h3>选择分类</h3>
                        <div class="category-grid" id="categoryGrid">
                            <!-- 动态生成分类按钮 -->
                        </div>
                    </div>

                    <div class="description-input">
                        <input type="text" id="descriptionInput" placeholder="添加描述（可选）">
                    </div>

                    <button class="save-btn" id="saveBtn">
                        <i class="fas fa-save"></i>
                        保存记录
                    </button>
                </div>

                <div class="recent-records">
                    <h3>最近记录</h3>
                    <div id="recentList" class="recent-list">
                        <!-- 动态生成最近记录 -->
                    </div>
                </div>
            </div>

            <!-- 统计页面 -->
            <div id="statsPage" class="page">
                <div class="stats-header">
                    <h2>收支统计</h2>
                    <div class="period-selector">
                        <button class="period-btn active" data-period="month">本月</button>
                        <button class="period-btn" data-period="week">本周</button>
                        <button class="period-btn" data-period="year">本年</button>
                        <button class="period-btn" data-period="all">全部</button>
                        <button class="period-btn" data-period="custom">自定义</button>
                    </div>
                    
                    <!-- 自定义日期范围选择器 -->
                    <div class="custom-date-range" id="customDateRange">
                        <div class="range-title">选择日期范围</div>
                        <div class="date-inputs">
                            <input type="date" id="customStartDate">
                            <span>至</span>
                            <input type="date" id="customEndDate">
                        </div>
                        <button class="apply-custom-range" id="applyCustomRange">应用</button>
                    </div>
                </div>

                <div class="stats-overview">
                    <div class="overview-card">
                        <div class="overview-label">总收入</div>
                        <div class="overview-value income" id="totalIncome">¥0</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-label">总支出</div>
                        <div class="overview-value expense" id="totalExpense">¥0</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-label">结余</div>
                        <div class="overview-value balance" id="totalBalance">¥0</div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-card">
                        <div class="chart-title">收支趋势图</div>
                        <div id="trendChart" class="chart chart-large"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">分类支出占比</div>
                        <div id="categoryChart" class="chart"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">月度对比</div>
                        <div id="monthlyChart" class="chart"></div>
                    </div>
                </div>

                <!-- 分类排行榜 -->
                <div class="category-ranking" id="categoryRanking">
                    <div class="ranking-header">
                        <div>
                            <div class="ranking-title">分类排行榜</div>
                            <div class="ranking-subtitle" id="rankingPeriod">本月</div>
                        </div>
                        <!-- 新增：排行榜类型切换按钮 -->
                        <div class="ranking-type-switcher">
                            <button class="ranking-type-btn active" data-type="income">收入</button>
                            <button class="ranking-type-btn" data-type="expense">支出</button>
                        </div>
                    </div>
                    <div class="ranking-list" id="rankingList">
                        <!-- 动态生成分类排行 -->
                    </div>
                </div>
            </div>

            <!-- 记录页面 -->
            <div id="recordsPage" class="page">
                <div class="records-header">
                    <h2>记账记录</h2>
                </div>
                <div class="records-tools">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="搜索记录...">
                    </div>
                    <button class="filter-btn" id="filterBtn">
                        <i class="fas fa-filter"></i>
                    </button>
                </div>

                <div class="filter-panel" id="filterPanel">
                    <div class="filter-row">
                        <label>类型：</label>
                        <select id="typeFilter">
                            <option value="">全部</option>
                            <option value="income">收入</option>
                            <option value="expense">支出</option>
                        </select>
                    </div>
                    <div class="filter-row">
                        <label>分类：</label>
                        <select id="categoryFilter">
                            <option value="">全部分类</option>
                        </select>
                    </div>
                    <div class="filter-row">
                        <label>日期：</label>
                        <input type="date" id="dateFilterStart">
                        <span>至</span>
                        <input type="date" id="dateFilterEnd">
                    </div>
                    <button class="apply-filter-btn" id="applyFilterBtn">应用筛选</button>
                </div>

                <div class="records-list" id="recordsList">
                    <!-- 动态生成记录列表 -->
                </div>

                <button class="load-more-btn" id="loadMoreBtn">加载更多</button>
            </div>

            <!-- 设置页面 -->
            <div id="settingsPage" class="page">
                <div class="settings-header">
                    <h2>设置</h2>
                </div>

                <div class="settings-content">
                    <!-- 数据管理 -->
                    <div class="settings-section">
                        <h3><i class="fas fa-database"></i> 数据管理</h3>
                        <div class="settings-item">
                            <div class="settings-info">
                                <div class="settings-title">导出数据</div>
                                <div class="settings-desc">将数据导出为CSV、JSON或PDF格式</div>
                            </div>
                            <button class="settings-btn" id="exportDataBtn">导出</button>
                        </div>
                        <div class="settings-item">
                            <div class="settings-info">
                                <div class="settings-title">导入数据</div>
                                <div class="settings-desc">从JSON或CSV文件导入数据</div>
                            </div>
                            <button class="settings-btn success" id="importDataBtn">导入</button>
                        </div>
                        <div class="settings-item">
                            <div class="settings-info">
                                <div class="settings-title">清空数据</div>
                                <div class="settings-desc">删除所有记账记录（不可恢复）</div>
                            </div>
                            <button class="settings-btn danger" id="clearDataBtn">清空</button>
                        </div>
                    </div>

                    <!-- 分类管理 -->
                    <div class="settings-section">
                        <h3><i class="fas fa-tags"></i> 分类管理</h3>
                        <div class="settings-item">
                            <div class="settings-info">
                                <div class="settings-title">自定义分类</div>
                                <div class="settings-desc">管理收入和支出分类</div>
                            </div>
                            <button class="settings-btn" id="manageCategoriesBtn">管理</button>
                        </div>
                    </div>

                    <!-- 应用设置 -->
                    <div class="settings-section">
                        <h3><i class="fas fa-cog"></i> 应用设置</h3>
                        <div class="settings-item">
                            <div class="settings-info">
                                <div class="settings-title">货币单位</div>
                                <div class="settings-desc">选择显示的货币单位</div>
                            </div>
                            <select class="settings-select" id="currencySelect">
                                <option value="CNY">¥ 人民币</option>
                                <option value="USD">$ 美元</option>
                                <option value="EUR">€ 欧元</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <div class="settings-info">
                                <div class="settings-title">预算设置</div>
                                <div class="settings-desc">设置月度预算提醒</div>
                            </div>
                            <button class="settings-btn" id="budgetBtn">设置</button>
                        </div>
                        <div class="settings-item">
                            <div class="settings-info">
                                <div class="settings-title">关于应用</div>
                                <div class="settings-desc">版本 5.0.0 | 专业记账工具</div>
                            </div>
                            <button class="settings-btn" id="aboutBtn">查看</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部导航 -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="accounting">
                <i class="fas fa-plus-circle"></i>
                <span>记账</span>
            </button>
            <button class="nav-item" data-page="stats">
                <i class="fas fa-chart-pie"></i>
                <span>统计</span>
            </button>
            <button class="nav-item" data-page="records">
                <i class="fas fa-list-alt"></i>
                <span>记录</span>
            </button>
            <button class="nav-item" data-page="settings">
                <i class="fas fa-cog"></i>
                <span>设置</span>
            </button>
        </nav>
    </div>

    <!-- 导出选项模态框 -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>导出数据</h3>
                <button class="close-btn" id="closeExportModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <label class="export-option">
                        <input type="radio" name="exportType" value="csv" checked>
                        <i class="fas fa-file-csv"></i>
                        <div class="option-content">
                            <div class="option-title">CSV格式</div>
                            <div class="option-desc">Excel兼容，便于数据分析</div>
                        </div>
                    </label>
                    <label class="export-option">
                        <input type="radio" name="exportType" value="json">
                        <i class="fas fa-file-code"></i>
                        <div class="option-content">
                            <div class="option-title">JSON格式</div>
                            <div class="option-desc">完整备份，保留所有信息</div>
                        </div>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelExport">取消</button>
                <button class="btn-primary" id="confirmExport">导出</button>
            </div>
        </div>
    </div>

    <!-- 导入模态框 -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>导入数据</h3>
                <button class="close-btn" id="closeImportModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="import-area">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>选择JSON或CSV文件</p>
                    <button class="import-btn" id="chooseFileBtn">选择文件</button>
                    <input type="file" id="importFileInput" accept=".json,.csv">
                </div>
                <div style="margin-top: 15px; font-size: 12px; color: #94a3b8;">
                    <p>• 支持海豚记账本导出的JSON格式</p>
                    <p>• 支持CSV格式</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelImport">取消</button>
                <button class="btn-primary" id="confirmImport" disabled>导入</button>
            </div>
        </div>
    </div>

    <!-- 预算设置模态框 -->
    <div class="modal" id="budgetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>月度预算设置</h3>
                <button class="close-btn" id="closeBudgetModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">月度预算金额（元）</label>
                    <input type="number" id="budgetInput" placeholder="输入预算金额" step="0.01" min="0" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelBudget">取消</button>
                <button class="btn-primary" id="saveBudget">保存</button>
            </div>
        </div>
    </div>

    <!-- 分类管理模态框 -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>分类管理</h3>
                <button class="close-btn" id="closeCategoryModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- 标签切换 -->
                <div class="tab-switcher">
                    <button class="tab-btn active" data-tab="income">收入分类</button>
                    <button class="tab-btn" data-tab="expense">支出分类</button>
                </div>

                <!-- 分类列表 -->
                <div class="category-manage-list" id="categoryManageList">
                    <!-- 动态生成分类列表 -->
                </div>

                <!-- 添加新分类表单 -->
                <div class="add-category-form">
                    <div class="form-row">
                        <label>分类名称</label>
                        <input type="text" id="newCategoryName" placeholder="输入分类名称" maxlength="10">
                    </div>
                    <div class="form-row">
                        <label>选择图标</label>
                        <div class="icon-selector" id="iconSelector">
                            <!-- 动态生成图标选项 -->
                        </div>
                    </div>
                    <button class="add-category-btn" id="addCategoryBtn">
                        <i class="fas fa-plus"></i> 添加分类
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 分类明细模态框 -->
    <div class="modal category-detail-modal" id="categoryDetailModal">
        <div class="modal-content">
            <div class="modal-header category-detail-header">
                <div class="category-detail-title">
                    <div class="category-detail-icon" id="detailIcon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="category-detail-info">
                        <h3 id="detailCategory">分类名称</h3>
                        <p id="detailPeriod">时间段</p>
                    </div>
                </div>
                <button class="close-btn" id="closeDetailModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="category-detail-summary" id="detailSummary">
                <div class="summary-item">
                    <div class="summary-label">笔数</div>
                    <div class="summary-value" id="detailCount">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">总额</div>
                    <div class="summary-value" id="detailTotal">¥0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">平均</div>
                    <div class="summary-value" id="detailAvg">¥0</div>
                </div>
            </div>
            <div class="category-detail-list" id="detailList">
                <!-- 动态生成分类明细 -->
            </div>
        </div>
    </div>

    <!-- 编辑记录模态框 -->
    <div class="modal" id="editRecordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑记录</h3>
                <button class="close-btn" id="closeEditRecordModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="edit-record-form">
                    <div class="amount-input">
                        <span class="currency">¥</span>
                        <input type="number" id="editAmountInput" placeholder="0.00" step="0.01" min="0">
                    </div>

                    <!-- 日期选择器 -->
                    <div class="date-input">
                        <i class="fas fa-calendar-alt"></i>
                        <input type="date" id="editDateInput" value="">
                    </div>

                    <div class="type-switcher" id="editTypeSwitcher">
                        <button class="type-btn active" data-type="income">
                            <i class="fas fa-arrow-up"></i>
                            <span>收入</span>
                        </button>
                        <button class="type-btn" data-type="expense">
                            <i class="fas fa-arrow-down"></i>
                            <span>支出</span>
                        </button>
                    </div>

                    <div class="category-picker">
                        <div class="category-picker-title">选择分类</div>
                        <div class="category-picker-grid" id="editCategoryGrid">
                            <!-- 动态生成分类选择器 -->
                        </div>
                    </div>

                    <div class="description-input">
                        <input type="text" id="editDescriptionInput" placeholder="添加描述（可选）">
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" id="cancelEditRecord">取消</button>
                        <button class="btn-primary" id="saveEditRecord">保存修改</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div class="modal" id="confirmDeleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>确认删除</h3>
                <button class="close-btn" id="closeConfirmDeleteModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="confirm-delete-content">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>确定要删除这条记录吗？</h4>
                    <p>此操作不可撤销，请谨慎操作</p>
                    
                    <div class="record-info" id="deleteRecordInfo">
                        <!-- 动态显示要删除的记录信息 -->
                    </div>
                    
                    <div class="warning">
                        <i class="fas fa-exclamation-circle"></i> 删除后数据将无法恢复
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelDelete">取消</button>
                <button class="btn-primary danger" id="confirmDelete">确认删除</button>
            </div>
        </div>
    </div>

    <!-- 提示消息 -->
    <div class="toast" id="toast"></div>

    <!-- 加载动画 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">处理中...</div>
        </div>
    </div>

    <script>
        // ============ IndexedDB存储类 ============
        class IndexedDBAccountingDB {
            constructor() {
                this.dbName = 'AccountingDB_v5';
                this.dbVersion = 2; // 增加版本号以支持更新记录功能
                this.db = null;
                this.categories = {
                    income: [
                        {name: '工资', icon: 'fa-money-bill-wave'},
                        //{name: '兼职', icon: 'fa-briefcase'},
                        {name: '理财', icon: 'fa-chart-line'},
                        //{name: '报销', icon: 'fa-receipt'},
                        {name: '奖金', icon: 'fa-gift'},
                        {name: '红包', icon: 'fa-envelope'},
                        {name: '其他', icon: 'fa-ellipsis-h'}
                    ],
                    expense: [
                        {name: '餐饮', icon: 'fa-utensils'},
                        {name: '购物', icon: 'fa-shopping-bag'},
                        {name: '交通', icon: 'fa-car'},
                        {name: '娱乐', icon: 'fa-gamepad'},
                        {name: '医疗', icon: 'fa-medkit'},
                        {name: '教育', icon: 'fa-book'},
                        //{name: '住房', icon: 'fa-home'},
                        {name: '通讯', icon: 'fa-phone'},
                        {name: '个护', icon: 'fa-spa'},
                        //{name: '宠物', icon: 'fa-paw'},
                        //{name: '运动', icon: 'fa-running'},
                        {name: '其他', icon: 'fa-ellipsis-h'}
                    ]
                };
                this.budget = 0;
                this.records = [];
                this.ready = this.initDB();
                this.editingRecordId = null; // 当前正在编辑的记录ID
                this.deletingRecordId = null; // 当前要删除的记录ID
            }

            async initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    
                    request.onerror = (event) => {
                        console.error('IndexedDB error:', event.target.error);
                        reject(event.target.error);
                    };
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        // 从IndexedDB加载数据到内存
                        this.loadAllData().then(resolve).catch(reject);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // 创建记录存储
                        if (!db.objectStoreNames.contains('records')) {
                            const store = db.createObjectStore('records', { keyPath: 'id' });
                            store.createIndex('date', 'date', { unique: false });
                            store.createIndex('type', 'type', { unique: false });
                            store.createIndex('category', 'category', { unique: false });
                        }
                        
                        // 创建分类存储
                        if (!db.objectStoreNames.contains('categories')) {
                            const store = db.createObjectStore('categories', { keyPath: 'type' });
                        }
                        
                        // 创建预算存储
                        if (!db.objectStoreNames.contains('budget')) {
                            db.createObjectStore('budget', { keyPath: 'id' });
                        }
                    };
                });
            }

            async loadAllData() {
                await this.loadRecords();
                await this.loadCategories();
                await this.loadBudget();
                this.categories = this.mergeCategories();
            }

            async loadRecords() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['records'], 'readonly');
                    const store = transaction.objectStore('records');
                    const request = store.getAll();
                    
                    request.onsuccess = (event) => {
                        this.records = event.target.result.sort((a, b) => 
                            new Date(b.date) - new Date(a.date)
                        );
                        resolve(this.records);
                    };
                    
                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            async loadCategories() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['categories'], 'readonly');
                    const store = transaction.objectStore('categories');
                    
                    this.customCategories = { income: [], expense: [] };
                    
                    // 加载收入分类
                    const incomeRequest = store.get('income');
                    incomeRequest.onsuccess = (event) => {
                        if (event.target.result) {
                            this.customCategories.income = event.target.result.categories || [];
                        }
                        
                        // 加载支出分类
                        const expenseRequest = store.get('expense');
                        expenseRequest.onsuccess = (event) => {
                            if (event.target.result) {
                                this.customCategories.expense = event.target.result.categories || [];
                            }
                            resolve(this.customCategories);
                        };
                        expenseRequest.onerror = reject;
                    };
                    incomeRequest.onerror = reject;
                });
            }

            async loadBudget() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['budget'], 'readonly');
                    const store = transaction.objectStore('budget');
                    const request = store.get('budget');
                    
                    request.onsuccess = (event) => {
                        if (event.target.result) {
                            this.budget = event.target.result.amount || 0;
                        }
                        resolve(this.budget);
                    };
                    
                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            mergeCategories() {
                const systemCategories = {
                    income: [
                        {name: '工资', icon: 'fa-money-bill-wave'},
                        //{name: '兼职', icon: 'fa-briefcase'},
                        {name: '理财', icon: 'fa-chart-line'},
                        //{name: '报销', icon: 'fa-receipt'},
                        {name: '奖金', icon: 'fa-gift'},
                        {name: '红包', icon: 'fa-envelope'},
                        {name: '其他', icon: 'fa-ellipsis-h'}
                    ],
                    expense: [
                        {name: '餐饮', icon: 'fa-utensils'},
                        {name: '购物', icon: 'fa-shopping-bag'},
                        {name: '交通', icon: 'fa-car'},
                        {name: '娱乐', icon: 'fa-gamepad'},
                        {name: '医疗', icon: 'fa-medkit'},
                        {name: '教育', icon: 'fa-book'},
                        //{name: '住房', icon: 'fa-home'},
                        {name: '通讯', icon: 'fa-phone'},
                        {name: '个护', icon: 'fa-spa'},
                        //{name: '宠物', icon: 'fa-paw'},
                        //{name: '运动', icon: 'fa-running'},
                        {name: '其他', icon: 'fa-ellipsis-h'}
                    ]
                };

                return {
                    income: [...systemCategories.income, ...this.customCategories.income],
                    expense: [...systemCategories.expense, ...this.customCategories.expense]
                };
            }

            async saveBudget(amount) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['budget'], 'readwrite');
                    const store = transaction.objectStore('budget');
                    const request = store.put({ id: 'budget', amount: amount });
                    
                    request.onsuccess = () => {
                        this.budget = amount;
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            async saveCustomCategories() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['categories'], 'readwrite');
                    const store = transaction.objectStore('categories');
                    
                    // 保存收入分类
                    const incomeRequest = store.put({ 
                        type: 'income', 
                        categories: this.customCategories.income 
                    });
                    
                    // 保存支出分类
                    const expenseRequest = store.put({ 
                        type: 'expense', 
                        categories: this.customCategories.expense 
                    });
                    
                    transaction.oncomplete = () => {
                        this.categories = this.mergeCategories();
                        resolve();
                    };
                    
                    transaction.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            async addCustomCategory(type, name, icon) {
                const exists = this.categories[type].some(c => c.name === name);
                if (exists) {
                    return { success: false, message: '该分类已存在' };
                }

                const category = { name, icon, isCustom: true };
                this.customCategories[type].push(category);
                await this.saveCustomCategories();
                
                return { success: true, category };
            }

            async deleteCustomCategory(type, name) {
                // 检查是否有相关记录
                const hasRecords = await this.hasCategoryRecords(type, name);
                if (hasRecords) {
                    return { success: false, message: '该分类下有记录，无法删除' };
                }

                const index = this.customCategories[type].findIndex(c => c.name === name);
                if (index !== -1) {
                    this.customCategories[type].splice(index, 1);
                    await this.saveCustomCategories();
                    return { success: true };
                }

                return { success: false, message: '分类不存在' };
            }

            async hasCategoryRecords(type, category) {
                const records = await this.getRecordsByCategory(type, category);
                return records.length > 0;
            }

            async getRecordsByCategory(type, category) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['records'], 'readonly');
                    const store = transaction.objectStore('records');
                    const typeIndex = store.index('type');
                    
                    const records = [];
                    const request = typeIndex.openCursor(IDBKeyRange.only(type));
                    
                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            if (cursor.value.category === category) {
                                records.push(cursor.value);
                            }
                            cursor.continue();
                        } else {
                            resolve(records);
                        }
                    };
                    
                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            async addRecord(record) {
                return new Promise((resolve, reject) => {
                    record.id = Date.now() + Math.random();
                    record.timestamp = new Date().toISOString();
                    
                    const transaction = this.db.transaction(['records'], 'readwrite');
                    const store = transaction.objectStore('records');
                    const request = store.add(record);
                    
                    request.onsuccess = () => {
                        this.records.unshift(record);
                        resolve(record.id);
                    };
                    
                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            async updateRecord(recordId, updatedRecord) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['records'], 'readwrite');
                    const store = transaction.objectStore('records');
                    
                    // 首先获取原始记录
                    const getRequest = store.get(recordId);
                    
                    getRequest.onsuccess = (event) => {
                        const originalRecord = event.target.result;
                        if (!originalRecord) {
                            reject(new Error('记录不存在'));
                            return;
                        }
                        
                        // 更新记录
                        const updated = {
                            ...originalRecord,
                            ...updatedRecord,
                            timestamp: new Date().toISOString() // 更新修改时间
                        };
                        
                        const putRequest = store.put(updated);
                        
                        putRequest.onsuccess = () => {
                            // 更新内存中的记录
                            const index = this.records.findIndex(r => r.id === recordId);
                            if (index !== -1) {
                                this.records[index] = updated;
                                // 重新排序
                                this.records.sort((a, b) => new Date(b.date) - new Date(a.date));
                            }
                            resolve(updated);
                        };
                        
                        putRequest.onerror = (event) => {
                            reject(event.target.error);
                        };
                    };
                    
                    getRequest.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            async deleteRecord(recordId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['records'], 'readwrite');
                    const store = transaction.objectStore('records');
                    const request = store.delete(recordId);
                    
                    request.onsuccess = () => {
                        // 从内存中删除记录
                        const index = this.records.findIndex(r => r.id === recordId);
                        if (index !== -1) {
                            this.records.splice(index, 1);
                        }
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            async getRecordById(recordId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['records'], 'readonly');
                    const store = transaction.objectStore('records');
                    const request = store.get(recordId);
                    
                    request.onsuccess = (event) => {
                        resolve(event.target.result);
                    };
                    
                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            async getRecords(filters = {}) {
                // 等待数据库就绪
                await this.ready;
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['records'], 'readonly');
                    const store = transaction.objectStore('records');
                    const request = store.getAll();
                    
                    request.onsuccess = (event) => {
                        let records = event.target.result;
                        
                        // 应用过滤器
                        if (filters.type) {
                            records = records.filter(r => r.type === filters.type);
                        }
                        
                        if (filters.category) {
                            records = records.filter(r => r.category === filters.category);
                        }
                        
                        if (filters.startDate) {
                            const start = new Date(filters.startDate);
                            records = records.filter(r => new Date(r.date) >= start);
                        }
                        
                        if (filters.endDate) {
                            const end = new Date(filters.endDate);
                            end.setHours(23, 59, 59);
                            records = records.filter(r => new Date(r.date) <= end);
                        }

                        if (filters.search) {
                            const search = filters.search.toLowerCase();
                            records = records.filter(r => 
                                (r.description && r.description.toLowerCase().includes(search)) ||
                                r.category.toLowerCase().includes(search)
                            );
                        }

                        // 按日期排序
                        records.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        resolve(records);
                    };
                    
                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            async getStats(period = 'month', customStart = null, customEnd = null) {
                const records = await this.getRecords();
                
                let startDate, endDate;
                const now = new Date();

                if (period === 'custom' && customStart && customEnd) {
                    startDate = new Date(customStart);
                    endDate = new Date(customEnd);
                    endDate.setHours(23, 59, 59);
                } else if (period === 'all') {
                    if (records.length === 0) {
                        startDate = new Date();
                        endDate = new Date();
                    } else {
                        const dates = records.map(r => new Date(r.date));
                        startDate = new Date(Math.min(...dates));
                        endDate = new Date(Math.max(...dates));
                        endDate.setHours(23, 59, 59);
                    }
                } else {
                    switch(period) {
                        case 'week':
                            startDate = new Date(now);
                            startDate.setDate(now.getDate() - 7);
                            endDate = now;
                            break;
                        case 'year':
                            startDate = new Date(now.getFullYear(), 0, 1);
                            endDate = now;
                            break;
                        case 'month':
                        default:
                            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            endDate = now;
                            break;
                    }
                }

                const periodRecords = records.filter(r => {
                    const recordDate = new Date(r.date);
                    return recordDate >= startDate && recordDate <= endDate;
                });

                const income = periodRecords.filter(r => r.type === 'income').reduce((sum, r) => sum + r.amount, 0);
                const expense = periodRecords.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.amount, 0);
                
                return { income, expense, records: periodRecords, startDate, endDate };
            }

            async getCategoryStats(period = 'month', customStart = null, customEnd = null, type = 'expense') {
                const { records } = await this.getStats(period, customStart, customEnd);
                const filteredRecords = records.filter(r => r.type === type);
                const categoryMap = new Map();
                
                filteredRecords.forEach(r => {
                    if (!categoryMap.has(r.category)) {
                        categoryMap.set(r.category, {
                            name: r.category,
                            amount: 0,
                            count: 0,
                            icon: this.categories[type].find(c => c.name === r.category)?.icon || 'fa-question'
                        });
                    }
                    categoryMap.get(r.category).amount += r.amount;
                    categoryMap.get(r.category).count += 1;
                });

                return Array.from(categoryMap.values())
                    .sort((a, b) => b.amount - a.amount)
                    .map((item, index) => ({
                        ...item,
                        rank: index + 1,
                        percentage: filteredRecords.reduce((sum, r) => sum + r.amount, 0) > 0 
                            ? (item.amount / filteredRecords.reduce((sum, r) => sum + r.amount, 0) * 100).toFixed(1)
                            : 0
                    }));
            }

            async getMonthlyTrend() {
                const records = await this.getRecords();
                
                if (records.length === 0) {
                    return { months: [], incomeData: [], expenseData: [] };
                }

                const dates = records.map(r => new Date(r.date));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                
                const months = [];
                const incomeData = [];
                const expenseData = [];
                
                let current = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
                const end = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);
                
                while (current <= end) {
                    const monthRecords = records.filter(r => {
                        const recordDate = new Date(r.date);
                        return recordDate.getFullYear() === current.getFullYear() && 
                               recordDate.getMonth() === current.getMonth();
                    });
                    
                    months.push(`${current.getFullYear()}年${current.getMonth() + 1}月`);
                    incomeData.push(monthRecords.filter(r => r.type === 'income').reduce((sum, r) => sum + r.amount, 0));
                    expenseData.push(monthRecords.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.amount, 0));
                    
                    current.setMonth(current.getMonth() + 1);
                }
                
                return { months, incomeData, expenseData };
            }

            async getCategoryDetailRecords(category, period = 'month', customStart = null, customEnd = null, type = 'expense') {
                const { records } = await this.getStats(period, customStart, customEnd);
                return records
                    .filter(r => r.type === type && r.category === category)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            async clearAllRecords() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['records'], 'readwrite');
                    const store = transaction.objectStore('records');
                    const request = store.clear();
                    
                    request.onsuccess = () => {
                        this.records = [];
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            async importRecords(newRecords) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['records'], 'readwrite');
                    const store = transaction.objectStore('records');
                    
                    let successCount = 0;
                    let errorCount = 0;
                    
                    // 为每条记录添加ID和时间戳
                    newRecords.forEach(record => {
                        if (!record.id) record.id = Date.now() + Math.random();
                        if (!record.timestamp) record.timestamp = new Date().toISOString();
                        
                        const request = store.add(record);
                        
                        request.onsuccess = () => {
                            successCount++;
                        };
                        
                        request.onerror = () => {
                            errorCount++;
                        };
                    });
                    
                    transaction.oncomplete = () => {
                        // 重新加载记录
                        this.loadRecords().then(() => {
                            resolve({ successCount, errorCount });
                        });
                    };
                    
                    transaction.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }
        }

        // ============ 图表统计类 ============
        class ChartManager {
            constructor(db) {
                this.db = db;
                this.charts = {};
                this.currentPeriod = 'month';
                this.customStartDate = null;
                this.customEndDate = null;
            }

            init() {
                this.initTrendChart();
                this.initCategoryChart();
                this.initMonthlyChart();
            }

            initTrendChart() {
                const dom = document.getElementById('trendChart');
                if (!dom) return;
                
                this.charts.trend = echarts.init(dom);
                this.updateTrendChart();
            }

            initCategoryChart() {
                const dom = document.getElementById('categoryChart');
                if (!dom) return;
                
                this.charts.category = echarts.init(dom);
                this.updateCategoryChart();
            }

            initMonthlyChart() {
                const dom = document.getElementById('monthlyChart');
                if (!dom) return;
                
                this.charts.monthly = echarts.init(dom);
                this.updateMonthlyChart();
            }

            async updateTrendChart(period = 'month', customStart = null, customEnd = null) {
                if (!this.charts.trend) return;
                
                const { records } = await this.db.getStats(period, customStart, customEnd);
                const dailyData = {};
                
                records.forEach(r => {
                    const date = new Date(r.date).toLocaleDateString();
                    if (!dailyData[date]) {
                        dailyData[date] = { income: 0, expense: 0 };
                    }
                    if (r.type === 'income') {
                        dailyData[date].income += r.amount;
                    } else {
                        dailyData[date].expense += r.amount;
                    }
                });

                const dates = Object.keys(dailyData).sort();
                const incomeData = dates.map(d => dailyData[d].income);
                const expenseData = dates.map(d => dailyData[d].expense);

                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' },
                        formatter: function(params) {
                            let result = params[0].name + '<br/>';
                            params.forEach(param => {
                                result += `${param.seriesName}: ¥${param.value.toFixed(2)}<br/>`;
                            });
                            return result;
                        }
                    },
                    legend: {
                        data: ['收入', '支出'],
                        top: 0
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: dates.map(d => new Date(d).getMonth() + 1 + '/' + new Date(d).getDate()),
                        axisLabel: { fontSize: 10 }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: { formatter: '¥{value}' }
                    },
                    series: [
                        {
                            name: '收入',
                            type: 'line',
                            data: incomeData,
                            itemStyle: { color: '#10b981' },
                            areaStyle: { color: 'rgba(16, 185, 129, 0.1)' }
                        },
                        {
                            name: '支出',
                            type: 'line',
                            data: expenseData,
                            itemStyle: { color: '#ef4444' },
                            areaStyle: { color: 'rgba(239, 68, 68, 0.1)' }
                        }
                    ]
                };

                this.charts.trend.setOption(option);
            }

            async updateCategoryChart(period = 'month', customStart = null, customEnd = null) {
                if (!this.charts.category) return;
                
                const categoryData = await this.db.getCategoryStats(period, customStart, customEnd, 'expense');
                const data = categoryData.map(item => ({
                    name: item.name,
                    value: item.amount
                }));

                const option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: ¥{c} ({d}%)'
                    },
                    series: [
                        {
                            name: '支出',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            center: ['50%', '50%'],
                            data: data,
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            },
                            itemStyle: {
                                borderRadius: 6,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: true,
                                formatter: '{b}\n¥{c}'
                            }
                        }
                    ]
                };

                this.charts.category.setOption(option);
            }

            async updateMonthlyChart() {
                if (!this.charts.monthly) return;
                
                const { months, incomeData, expenseData } = await this.db.getMonthlyTrend();

                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' }
                    },
                    legend: {
                        data: ['收入', '支出'],
                        top: 0
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: months,
                        axisLabel: { fontSize: 10, rotate: 45 }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: { formatter: '¥{value}' }
                    },
                    series: [
                        {
                            name: '收入',
                            type: 'bar',
                            data: incomeData,
                            itemStyle: { color: '#10b981', borderRadius: [4, 4, 0, 0] }
                        },
                        {
                            name: '支出',
                            type: 'bar',
                            data: expenseData,
                            itemStyle: { color: '#ef4444', borderRadius: [4, 4, 0, 0] }
                        }
                    ]
                };

                this.charts.monthly.setOption(option);
            }

            async updateAllCharts(period = 'month', customStart = null, customEnd = null) {
                this.currentPeriod = period;
                this.customStartDate = customStart;
                this.customEndDate = customEnd;
                
                await this.updateTrendChart(period, customStart, customEnd);
                await this.updateCategoryChart(period, customStart, customEnd);
                await this.updateMonthlyChart();
            }

            resize() {
                Object.values(this.charts).forEach(chart => chart.resize());
            }
        }

        // ============ 导出导入管理类 ============
        class ExportImportManager {
            constructor(db) {
                this.db = db;
            }

            exportToCSV() {
                return new Promise(async (resolve, reject) => {
                    try {
                        const records = await this.db.getRecords();
                        const headers = ['日期', '类型', '分类', '金额', '描述'];
                        const csvContent = [
                            headers.join(','),
                            ...records.map(r => [
                                new Date(r.date).toLocaleDateString('zh-CN'),
                                r.type === 'income' ? '收入' : '支出',
                                r.category,
                                r.amount,
                                `"${r.description || ''}"`
                            ].join(','))
                        ].join('\n');

                        this.downloadFile(csvContent, '记账数据.csv', 'text/csv;charset=utf-8;');
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            exportToJSON() {
                return new Promise(async (resolve, reject) => {
                    try {
                        const records = await this.db.getRecords();
                        const data = {
                            version: '5.0',
                            exportDate: new Date().toISOString(),
                            records: records,
                            budget: this.db.budget,
                            customCategories: this.db.customCategories
                        };
                        this.downloadFile(JSON.stringify(data, null, 2), '记账数据.json', 'application/json;charset=utf-8;');
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            exportToPDF() {
                alert('PDF导出功能需要jspdf库支持，请先引入jspdf');
            }

            downloadFile(content, filename, contentType) {
                const blob = new Blob([content], { type: contentType });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            }

            async importFromJSON(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.records && Array.isArray(data.records)) {
                                resolve({ 
                                    records: data.records, 
                                    categories: data.customCategories || null,
                                    budget: data.budget || 0
                                });
                            } else {
                                reject('无效的数据格式');
                            }
                        } catch (error) {
                            reject('JSON解析失败');
                        }
                    };
                    reader.readAsText(file);
                });
            }

            async importFromCSV(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const lines = e.target.result.split('\n').filter(line => line.trim());
                            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                            
                            const records = [];
                            for (let i = 1; i < lines.length; i++) {
                                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                                const record = {
                                    id: Date.now() + Math.random(),
                                    timestamp: new Date().toISOString(),
                                    date: new Date(values[0]).toISOString() || new Date().toISOString(),
                                    type: values[1] === '支出' ? 'expense' : 'income',
                                    category: values[2] || '其他',
                                    amount: parseFloat(values[3]) || 0,
                                    description: values[4] || ''
                                };
                                records.push(record);
                            }
                            resolve({ records, categories: null, budget: 0 });
                        } catch (error) {
                            reject('CSV解析失败');
                        }
                    };
                    reader.readAsText(file);
                });
            }

            async mergeRecords(newRecords) {
                const existingRecords = await this.db.getRecords();
                const existingIds = new Set(existingRecords.map(r => r.id));
                const filtered = newRecords.filter(r => !existingIds.has(r.id));
                
                await this.db.importRecords(filtered);
                
                return { imported: filtered.length, total: newRecords.length };
            }

            async mergeCategories(newCategories) {
                if (!newCategories) return { imported: 0, total: 0 };
                
                let imported = 0;
                ['income', 'expense'].forEach(type => {
                    if (newCategories[type]) {
                        newCategories[type].forEach(cat => {
                            const exists = this.db.customCategories[type].some(c => c.name === cat.name);
                            if (!exists) {
                                this.db.customCategories[type].push(cat);
                                imported++;
                            }
                        });
                    }
                });
                
                await this.db.saveCustomCategories();
                
                return { imported, total: Object.values(newCategories).flat().length };
            }

            async mergeBudget(newBudget) {
                if (newBudget) {
                    await this.db.saveBudget(newBudget);
                    return true;
                }
                return false;
            }
        }

        // ============ 应用主类（IndexedDB版） ============
        class AccountingApp {
            constructor() {
                this.db = new IndexedDBAccountingDB();
                this.chartManager = null;
                this.exportManager = null;
                this.currentType = 'expense';
                this.currentCategory = null;
                this.recordsPage = 1;
                this.recordsPerPage = 20;
                this.currentFilters = {};
                this.currentCategoryTab = 'income';
                this.selectedIcon = 'fa-tag';
                this.currentRankingType = 'income';
                this.init();
            }

            async init() {
                // 等待数据库初始化完成
                try {
                    await this.db.ready;
                    this.chartManager = new ChartManager(this.db);
                    this.exportManager = new ExportImportManager(this.db);
                    
                    this.bindEvents();
                    this.renderCategories();
                    await this.updateStats();
                    await this.renderRecentRecords();
                    await this.renderCategoryRanking();
                    this.updateTime();
                    this.initDateInput();
                    setInterval(() => this.updateTime(), 1000);
                    setTimeout(() => this.chartManager.init(), 100);
                    window.addEventListener('resize', () => this.chartManager.resize());
                } catch (error) {
                    console.error('应用初始化失败:', error);
                    this.showToast('数据库初始化失败，请刷新页面重试');
                }
            }

            bindEvents() {
                // 收入支出切换
                document.querySelectorAll('.type-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentType = btn.dataset.type;
                        this.currentCategory = null;
                        this.renderCategories();
                    });
                });

                // 保存按钮
                document.getElementById('saveBtn').addEventListener('click', () => this.saveRecord());

                // 导航切换
                document.querySelectorAll('.nav-item').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchPage(btn.dataset.page);
                    });
                });

                // 统计周期切换
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const period = btn.dataset.period;
                        const customRange = document.getElementById('customDateRange');
                        customRange.classList.remove('show');
                        
                        if (period === 'custom') {
                            customRange.classList.add('show');
                            const endDate = new Date();
                            const startDate = new Date();
                            startDate.setMonth(endDate.getMonth() - 1);
                            document.getElementById('customStartDate').value = startDate.toISOString().split('T')[0];
                            document.getElementById('customEndDate').value = endDate.toISOString().split('T')[0];
                        } else if (period === 'all') {
                            await this.updateStats('all');
                            await this.renderCategoryRanking('all');
                            this.chartManager.updateAllCharts('all');
                        } else {
                            await this.updateStats(period);
                            await this.renderCategoryRanking(period);
                            this.chartManager.updateAllCharts(period);
                        }
                    });
                });

                // 应用自定义日期范围
                document.getElementById('applyCustomRange').addEventListener('click', async () => {
                    const startDate = document.getElementById('customStartDate').value;
                    const endDate = document.getElementById('customEndDate').value;
                    
                    if (!startDate || !endDate) {
                        this.showToast('请选择完整的日期范围');
                        return;
                    }
                    
                    if (new Date(startDate) > new Date(endDate)) {
                        this.showToast('开始日期不能晚于结束日期');
                        return;
                    }
                    
                    await this.updateStats('custom', startDate, endDate);
                    await this.renderCategoryRanking('custom', startDate, endDate);
                    this.chartManager.updateAllCharts('custom', startDate, endDate);
                    this.showToast('自定义范围已应用');
                });

                // 新增：排行榜类型切换事件
                document.querySelectorAll('.ranking-type-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        document.querySelectorAll('.ranking-type-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentRankingType = btn.dataset.type;
                        await this.renderCategoryRanking(
                            this.chartManager.currentPeriod, 
                            this.chartManager.customStartDate, 
                            this.chartManager.customEndDate
                        );
                    });
                });

                // 筛选功能
                document.getElementById('filterBtn').addEventListener('click', () => {
                    const panel = document.getElementById('filterPanel');
                    panel.classList.toggle('show');
                });

                document.getElementById('applyFilterBtn').addEventListener('click', () => this.applyFilters());
                document.getElementById('searchInput').addEventListener('input', async (e) => {
                    this.currentFilters.search = e.target.value;
                    await this.renderRecords();
                });

                // 加载更多
                document.getElementById('loadMoreBtn').addEventListener('click', () => {
                    this.recordsPage++;
                    this.renderRecords();
                });

                // 设置按钮
                this.bindSettingEvents();

                // 模态框关闭
                document.querySelectorAll('.close-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.closeModals());
                });

                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) this.closeModals();
                    });
                });

                // 货币单位变化
                document.getElementById('currencySelect').addEventListener('change', (e) => {
                    this.showToast('货币单位已更改（仅显示，不影响数据）');
                });

                // 编辑记录表单事件
                this.bindEditRecordEvents();

                // 删除记录事件
                this.bindDeleteRecordEvents();
            }

            bindEditRecordEvents() {
                // 编辑类型切换
                document.querySelectorAll('#editTypeSwitcher .type-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('#editTypeSwitcher .type-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.renderEditCategories(btn.dataset.type);
                    });
                });

                // 取消编辑
                document.getElementById('cancelEditRecord').addEventListener('click', () => {
                    this.closeModals();
                });

                // 保存编辑
                document.getElementById('saveEditRecord').addEventListener('click', async () => {
                    await this.saveEditedRecord();
                });

                // 关闭编辑模态框
                document.getElementById('closeEditRecordModal').addEventListener('click', () => {
                    this.closeModals();
                });
            }

            bindDeleteRecordEvents() {
                // 取消删除
                document.getElementById('cancelDelete').addEventListener('click', () => {
                    this.closeModals();
                });

                // 确认删除
                document.getElementById('confirmDelete').addEventListener('click', async () => {
                    await this.confirmDeleteRecord();
                });

                // 关闭删除确认模态框
                document.getElementById('closeConfirmDeleteModal').addEventListener('click', () => {
                    this.closeModals();
                });
            }

            bindSettingEvents() {
                // 导出数据
                document.getElementById('exportDataBtn').addEventListener('click', () => {
                    document.getElementById('exportModal').classList.add('show');
                });

                document.getElementById('cancelExport').addEventListener('click', () => this.closeModals());
                document.getElementById('confirmExport').addEventListener('click', async () => {
                    const selectedType = document.querySelector('input[name="exportType"]:checked').value;
                    try {
                        this.showLoading(true);
                        switch(selectedType) {
                            case 'csv':
                                await this.exportManager.exportToCSV();
                                break;
                            case 'json':
                                await this.exportManager.exportToJSON();
                                break;
                            case 'pdf':
                                this.exportManager.exportToPDF();
                                break;
                        }
                        this.closeModals();
                        this.showToast('导出成功！');
                    } catch (error) {
                        this.showToast('导出失败：' + error.message);
                    } finally {
                        this.showLoading(false);
                    }
                });

                // 导入数据
                document.getElementById('importDataBtn').addEventListener('click', () => {
                    document.getElementById('importModal').classList.add('show');
                });

                document.getElementById('chooseFileBtn').addEventListener('click', () => {
                    document.getElementById('importFileInput').click();
                });

                document.getElementById('importFileInput').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('confirmImport').disabled = false;
                    }
                });

                document.getElementById('cancelImport').addEventListener('click', () => this.closeModals());
                document.getElementById('confirmImport').addEventListener('click', async () => {
                    const file = document.getElementById('importFileInput').files[0];
                    if (!file) return;

                    this.showLoading(true);
                    try {
                        let result;
                        if (file.name.endsWith('.json')) {
                            result = await this.exportManager.importFromJSON(file);
                        } else if (file.name.endsWith('.csv')) {
                            result = await this.exportManager.importFromCSV(file);
                        }
                        
                        const recordResult = await this.exportManager.mergeRecords(result.records);
                        const catResult = result.categories ? await this.exportManager.mergeCategories(result.categories) : { imported: 0 };
                        const budgetResult = await this.exportManager.mergeBudget(result.budget);
                        
                        this.closeModals();
                        this.showToast(`成功导入 ${recordResult.imported} 条记录${catResult.imported ? '和 ' + catResult.imported + ' 个分类' : ''}${budgetResult ? '及预算设置' : ''}`);
                        
                        // 刷新数据
                        await this.updateStats(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                        await this.renderCategoryRanking(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                        await this.renderRecentRecords();
                        await this.renderRecords();
                        this.renderCategories();
                        this.chartManager.updateAllCharts(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                    } catch (error) {
                        this.showToast('导入失败：' + error);
                    } finally {
                        this.showLoading(false);
                    }
                });

                // 清空数据
                document.getElementById('clearDataBtn').addEventListener('click', async () => {
                    if (confirm('确定要清空所有数据吗？此操作不可恢复！建议先导出备份。')) {
                        try {
                            this.showLoading(true);
                            await this.db.clearAllRecords();
                            await this.updateStats(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                            await this.renderCategoryRanking(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                            await this.renderRecentRecords();
                            await this.renderRecords();
                            this.chartManager.updateAllCharts(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                            this.showToast('数据已清空');
                        } catch (error) {
                            this.showToast('清空失败：' + error.message);
                        } finally {
                            this.showLoading(false);
                        }
                    }
                });

                // 预算设置
                document.getElementById('budgetBtn').addEventListener('click', async () => {
                    document.getElementById('budgetInput').value = this.db.budget || '';
                    document.getElementById('budgetModal').classList.add('show');
                });

                document.getElementById('cancelBudget').addEventListener('click', () => this.closeModals());
                document.getElementById('saveBudget').addEventListener('click', async () => {
                    const budget = parseFloat(document.getElementById('budgetInput').value) || 0;
                    try {
                        await this.db.saveBudget(budget);
                        this.closeModals();
                        this.showToast('预算设置已保存');
                    } catch (error) {
                        this.showToast('保存失败：' + error.message);
                    }
                });

                // 分类管理
                document.getElementById('manageCategoriesBtn').addEventListener('click', () => {
                    this.openCategoryModal();
                });

                document.getElementById('closeCategoryModal').addEventListener('click', () => this.closeModals());

                // 分类标签切换
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentCategoryTab = btn.dataset.tab;
                        await this.renderCategoryManageList();
                    });
                });

                // 添加分类
                document.getElementById('addCategoryBtn').addEventListener('click', async () => {
                    await this.addCustomCategory();
                });

                // 分类名称输入验证
                document.getElementById('newCategoryName').addEventListener('input', () => {
                    this.validateCategoryInput();
                });

                // 分类明细模态框关闭
                document.getElementById('closeDetailModal').addEventListener('click', () => {
                    this.closeModals();
                });

                // 关于应用
                document.getElementById('aboutBtn').addEventListener('click', () => {
                    alert('海豚记账本 v5.0.0\n\n专业记账工具，帮您轻松管理财务\n\n功能特点：\n• IndexedDB存储，数据更安全\n• 支持自定义收入支出分类\n• 可选日期记账\n• 专业图表统计分析（支持全部年份和自定义范围）\n• 分类排行榜（收入/支出），点击查看明细\n• 数据导出导入\n• 预算管理提醒\n• 记录筛选与搜索\n• 记录编辑和删除功能');
                });
            }

            initDateInput() {
                const dateInput = document.getElementById('dateInput');
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }

            renderCategories() {
                const grid = document.getElementById('categoryGrid');
                const categories = this.db.categories[this.currentType];
                
                grid.innerHTML = categories.map(cat => `
                    <button class="category-btn" data-category="${cat.name}">
                        <i class="fas ${cat.icon}"></i>
                        <span>${cat.name}</span>
                    </button>
                `).join('');

                grid.querySelectorAll('.category-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        grid.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentCategory = btn.dataset.category;
                    });
                });
            }

            renderEditCategories(type) {
                const grid = document.getElementById('editCategoryGrid');
                const categories = this.db.categories[type];
                
                grid.innerHTML = categories.map(cat => `
                    <button class="category-picker-btn" data-category="${cat.name}">
                        <i class="fas ${cat.icon}"></i>
                        <span>${cat.name}</span>
                    </button>
                `).join('');

                // 绑定分类选择事件
                grid.querySelectorAll('.category-picker-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        grid.querySelectorAll('.category-picker-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    });
                });
            }

            async saveRecord() {
                const amount = parseFloat(document.getElementById('amountInput').value);
                const description = document.getElementById('descriptionInput').value;
                const date = document.getElementById('dateInput').value;

                if (!amount || amount <= 0) {
                    this.showToast('请输入有效金额');
                    return;
                }

                if (!this.currentCategory) {
                    this.showToast('请选择分类');
                    return;
                }

                const record = {
                    type: this.currentType,
                    amount: amount,
                    category: this.currentCategory,
                    description: description,
                    date: date || new Date().toISOString().split('T')[0]
                };

                try {
                    await this.db.addRecord(record);
                    
                    document.getElementById('amountInput').value = '';
                    document.getElementById('descriptionInput').value = '';
                    this.currentCategory = null;
                    this.renderCategories();
                    
                    await this.updateStats(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                    await this.renderCategoryRanking(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                    await this.renderRecentRecords();
                    this.showToast('记录已保存！');
                } catch (error) {
                    this.showToast('保存失败：' + error.message);
                }
            }

            // 打开编辑记录模态框
			// 修改openEditRecordModal方法
			async openEditRecordModal(recordId) {
				try {
					console.log('尝试打开编辑模态框，recordId:', recordId, '类型:', typeof recordId);
					
					// 添加ID类型转换逻辑
					let idToUse = recordId;
					
					// 如果recordId是字符串，尝试转换为数字
					if (typeof recordId === 'string') {
						// 尝试转换为数字
						const numId = parseFloat(recordId);
						if (!isNaN(numId)) {
							idToUse = numId;
						}
					}
					
					console.log('转换后的ID:', idToUse, '类型:', typeof idToUse);
					
					const record = await this.db.getRecordById(idToUse);
					console.log('查询到的记录:', record);
					
					if (!record) {
						this.showToast('记录不存在');
						return;
					}

					this.db.editingRecordId = idToUse;

					// 填充表单数据
					document.getElementById('editAmountInput').value = record.amount;
					document.getElementById('editDateInput').value = record.date;
					document.getElementById('editDescriptionInput').value = record.description || '';

					// 设置类型
					document.querySelectorAll('#editTypeSwitcher .type-btn').forEach(btn => {
						btn.classList.remove('active');
						if (btn.dataset.type === record.type) {
							btn.classList.add('active');
						}
					});

					// 渲染分类选择器
					this.renderEditCategories(record.type);

					// 设置选中的分类
					setTimeout(() => {
						const categoryBtns = document.querySelectorAll('#editCategoryGrid .category-picker-btn');
						categoryBtns.forEach(btn => {
							if (btn.dataset.category === record.category) {
								btn.classList.add('active');
							}
						});
					}, 100);

					// 显示模态框
					document.getElementById('editRecordModal').classList.add('show');
				} catch (error) {
					console.error('打开编辑模态框失败:', error);
					this.showToast('加载记录失败: ' + error.message);
				}
			}

            // 保存编辑后的记录
            async saveEditedRecord() {
                const recordId = this.db.editingRecordId;
                if (!recordId) return;

                const amount = parseFloat(document.getElementById('editAmountInput').value);
                const date = document.getElementById('editDateInput').value;
                const description = document.getElementById('editDescriptionInput').value;
                
                // 获取选中的类型
                const typeBtn = document.querySelector('#editTypeSwitcher .type-btn.active');
                const type = typeBtn ? typeBtn.dataset.type : 'expense';
                
                // 获取选中的分类
                const categoryBtn = document.querySelector('#editCategoryGrid .category-picker-btn.active');
                const category = categoryBtn ? categoryBtn.dataset.category : null;

                if (!amount || amount <= 0) {
                    this.showToast('请输入有效金额');
                    return;
                }

                if (!category) {
                    this.showToast('请选择分类');
                    return;
                }

                const updatedRecord = {
                    amount: amount,
                    date: date,
                    type: type,
                    category: category,
                    description: description
                };

                try {
                    this.showLoading(true);
                    await this.db.updateRecord(recordId, updatedRecord);
                    
                    this.closeModals();
                    this.showToast('记录修改成功！');
                    
                    // 刷新数据
                    await this.updateStats(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                    await this.renderCategoryRanking(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                    await this.renderRecentRecords();
                    await this.renderRecords();
                    this.chartManager.updateAllCharts(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                } catch (error) {
                    console.error('保存编辑记录失败:', error);
                    this.showToast('修改失败：' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            // 打开确认删除模态框
            async openConfirmDeleteModal(recordId) {
                try {
                    const record = await this.db.getRecordById(recordId);
                    if (!record) {
                        this.showToast('记录不存在');
                        return;
                    }

                    this.db.deletingRecordId = recordId;

                    // 显示记录信息
                    const recordInfo = document.getElementById('deleteRecordInfo');
                    const icon = this.db.categories[record.type].find(c => c.name === record.category)?.icon || 'fa-question';
                    const date = new Date(record.date).toLocaleDateString('zh-CN');
                    const typeText = record.type === 'income' ? '收入' : '支出';
                    const amountClass = record.type === 'income' ? 'income' : 'expense';
                    const amountSign = record.type === 'income' ? '+' : '-';
                    
                    recordInfo.innerHTML = `
                        <div>
                            <span class="label">分类：</span>
                            <span class="value"><i class="fas ${icon}"></i> ${record.category}</span>
                        </div>
                        <div>
                            <span class="label">类型：</span>
                            <span class="value">${typeText}</span>
                        </div>
                        <div>
                            <span class="label">日期：</span>
                            <span class="value">${date}</span>
                        </div>
                        <div>
                            <span class="label">金额：</span>
                            <span class="value ${amountClass}">${amountSign}¥${record.amount.toFixed(2)}</span>
                        </div>
                        ${record.description ? `<div>
                            <span class="label">描述：</span>
                            <span class="value">${record.description}</span>
                        </div>` : ''}
                    `;

                    // 显示模态框
                    document.getElementById('confirmDeleteModal').classList.add('show');
                } catch (error) {
                    console.error('打开删除确认模态框失败:', error);
                    this.showToast('加载记录失败');
                }
            }

            // 确认删除记录
            async confirmDeleteRecord() {
                const recordId = this.db.deletingRecordId;
                if (!recordId) return;

                try {
                    this.showLoading(true);
                    await this.db.deleteRecord(recordId);
                    
                    this.closeModals();
                    this.showToast('记录删除成功！');
                    
                    // 刷新数据
                    await this.updateStats(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                    await this.renderCategoryRanking(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                    await this.renderRecentRecords();
                    await this.renderRecords();
                    this.chartManager.updateAllCharts(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                } catch (error) {
                    console.error('删除记录失败:', error);
                    this.showToast('删除失败：' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async updateStats(period = 'month', customStart = null, customEnd = null) {
                try {
                    const stats = await this.db.getStats(period, customStart, customEnd);
                    
                    if (document.getElementById('accountingPage').classList.contains('active')) {
                        document.getElementById('monthIncome').textContent = `¥${stats.income.toFixed(2)}`;
                        document.getElementById('monthExpense').textContent = `¥${stats.expense.toFixed(2)}`;
                    }
                    
                    if (document.getElementById('statsPage').classList.contains('active')) {
                        document.getElementById('totalIncome').textContent = `¥${stats.income.toFixed(2)}`;
                        document.getElementById('totalExpense').textContent = `¥${stats.expense.toFixed(2)}`;
                        document.getElementById('totalBalance').textContent = `¥${(stats.income - stats.expense).toFixed(2)}`;
                    }
                } catch (error) {
                    console.error('更新统计失败:', error);
                }
            }

            async renderRecentRecords() {
                const recentList = document.getElementById('recentList');
                try {
                    const records = await this.db.getRecords();
                    const recentRecords = records.slice(0, 10);
                    
                    if (recentRecords.length === 0) {
                        recentList.innerHTML = '<div style="text-align: center; padding: 40px; color: #94a3b8;">暂无记录</div>';
                        return;
                    }

                    recentList.innerHTML = recentRecords.map(record => {
                        const icon = this.db.categories[record.type].find(c => c.name === record.category)?.icon || 'fa-question';
                        const date = new Date(record.date).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                        return `
                            <div class="recent-item">
                                <div class="recent-item-info">
                                    <div class="recent-item-icon">
                                        <i class="fas ${icon}"></i>
                                    </div>
                                    <div class="recent-item-details">
                                        <h4>${record.category}</h4>
                                        <p>${date} ${record.description || '无描述'}</p>
                                    </div>
                                </div>
                                <div class="recent-item-amount ${record.type}">
                                    ${record.type === 'income' ? '+' : '-'}¥${record.amount.toFixed(2)}
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('渲染最近记录失败:', error);
                    recentList.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">加载失败</div>';
                }
            }

            // 渲染分类排行榜（支持收入和支出）
            async renderCategoryRanking(period = 'month', customStart = null, customEnd = null) {
                const rankingList = document.getElementById('rankingList');
                const rankingPeriod = document.getElementById('rankingPeriod');
                
                try {
                    const categoryData = await this.db.getCategoryStats(period, customStart, customEnd, this.currentRankingType);
                    
                    // 更新排行榜标题
                    const periodText = {
                        'month': '本月',
                        'week': '本周',
                        'year': '本年',
                        'all': '全部',
                        'custom': '自定义'
                    };
                    rankingPeriod.textContent = periodText[period] || '本月';
                    
                    if (categoryData.length === 0) {
                        rankingList.innerHTML = '<div style="text-align: center; padding: 40px; color: #94a3b8;">暂无数据</div>';
                        return;
                    }

                    rankingList.innerHTML = categoryData.map((item, index) => {
                        const rankClass = index < 3 ? `top${index + 1}` : 'normal';
                        const amountClass = this.currentRankingType === 'income' ? 'income' : 'expense';
                        const sign = this.currentRankingType === 'income' ? '+' : '-';
                        
                        return `
                            <div class="ranking-item" onclick="app.showCategoryDetail('${item.name}', '${period}', '${customStart || ''}', '${customEnd || ''}', '${this.currentRankingType}')">
                                <div class="ranking-left">
                                    <div class="ranking-number ${rankClass}">${item.rank}</div>
                                    <div class="ranking-icon">
                                        <i class="fas ${item.icon}"></i>
                                    </div>
                                    <div class="ranking-info">
                                        <div class="ranking-category">${item.name}</div>
                                        <div class="ranking-count">${item.count} 笔</div>
                                    </div>
                                </div>
                                <div class="ranking-right">
                                    <div class="ranking-amount ${amountClass}">${sign}¥${item.amount.toFixed(2)}</div>
                                    <div class="ranking-percentage">${item.percentage}%</div>
                                    <div class="ranking-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('渲染分类排行榜失败:', error);
                    rankingList.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">加载失败</div>';
                }
            }

            // 显示分类明细（支持收入和支出）
            async showCategoryDetail(category, period, customStart, customEnd, type = 'expense') {
                const modal = document.getElementById('categoryDetailModal');
                
                try {
                    const records = await this.db.getCategoryDetailRecords(category, period, customStart || null, customEnd || null, type);
                    
                    // 更新模态框标题
                    const icon = this.db.categories[type].find(c => c.name === category)?.icon || 'fa-question';
                    document.getElementById('detailIcon').innerHTML = `<i class="fas ${icon}"></i>`;
                    document.getElementById('detailCategory').textContent = category;
                    
                    // 更新时间段显示
                    const periodText = {
                        'month': '本月',
                        'week': '本周',
                        'year': '本年',
                        'all': '全部',
                        'custom': '自定义'
                    };
                    document.getElementById('detailPeriod').textContent = periodText[period] || '本月';
                    
                    // 计算统计数据
                    const total = records.reduce((sum, r) => sum + r.amount, 0);
                    const avg = records.length > 0 ? total / records.length : 0;
                    
                    // 更新汇总信息
                    document.getElementById('detailCount').textContent = records.length + ' 笔';
                    document.getElementById('detailTotal').textContent = `¥${total.toFixed(2)}`;
                    document.getElementById('detailAvg').textContent = `¥${avg.toFixed(2)}`;
                    
                    // 渲染明细列表
                    const detailList = document.getElementById('detailList');
                    if (records.length === 0) {
                        detailList.innerHTML = '<div style="text-align: center; padding: 40px; color: #94a3b8;">暂无记录</div>';
                    } else {
                        detailList.innerHTML = records.map(record => {
                            const date = new Date(record.date).toLocaleDateString('zh-CN');
                            const amountClass = type === 'income' ? 'income' : 'expense';
                            const sign = type === 'income' ? '+' : '-';
                            return `
                                <div class="detail-item">
                                    <div class="detail-left">
                                        <div class="detail-date">${date}</div>
                                        <div class="detail-desc">${record.description || '无描述'}</div>
                                    </div>
                                    <div class="detail-amount ${amountClass}">${sign}¥${record.amount.toFixed(2)}</div>
                                </div>
                            `;
                        }).join('');
                    }
                    
                    // 显示模态框
                    modal.classList.add('show');
                } catch (error) {
                    console.error('显示分类详情失败:', error);
                    this.showToast('加载分类详情失败');
                }
            }

            switchPage(pageName) {
                document.querySelectorAll('.nav-item').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.page === pageName);
                });

                document.querySelectorAll('.page').forEach(page => {
                    page.classList.toggle('active', page.id === pageName + 'Page');
                });

                if (pageName === 'stats') {
                    this.updateStats(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                    this.renderCategoryRanking(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate);
                    setTimeout(() => this.chartManager.updateAllCharts(this.chartManager.currentPeriod, this.chartManager.customStartDate, this.chartManager.customEndDate), 100);
                } else if (pageName === 'records') {
                    this.recordsPage = 1;
                    this.renderRecords();
                    this.updateCategoryFilter();
                }
            }

            async renderRecords() {
                const recordsList = document.getElementById('recordsList');
                
                try {
                    const records = await this.db.getRecords(this.currentFilters);
                    const paginated = records.slice(0, this.recordsPage * this.recordsPerPage);
                    
                    if (paginated.length === 0) {
                        recordsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #94a3b8;">暂无记录</div>';
                        return;
                    }

					// 在renderRecords方法中修改按钮的onclick事件
					recordsList.innerHTML = paginated.map(record => {
						const icon = this.db.categories[record.type].find(c => c.name === record.category)?.icon || 'fa-question';
						const date = new Date(record.date).toLocaleDateString('zh-CN');
						
						return `
							<div class="record-item">
								<div class="record-main">
									<div class="record-icon">
										<i class="fas ${icon}"></i>
									</div>
									<div class="record-info">
										<h4>${record.category}</h4>
										<div class="record-meta">
											<span>${date}</span>
											${record.description ? `<span>${record.description}</span>` : ''}
										</div>
									</div>
								</div>
								<div class="record-amount ${record.type}">
									${record.type === 'income' ? '+' : '-'}¥${record.amount.toFixed(2)}
								</div>
								<div class="record-actions">
									<button class="record-action-btn record-edit-btn" onclick="app.openEditRecordModal(${JSON.stringify(record.id)})" title="编辑">
										<i class="fas fa-edit"></i>
									</button>
									<button class="record-action-btn record-delete-btn" onclick="app.openConfirmDeleteModal(${JSON.stringify(record.id)})" title="删除">
										<i class="fas fa-trash"></i>
									</button>
								</div>
							</div>
						`;
					}).join('');

                    const loadMoreBtn = document.getElementById('loadMoreBtn');
                    loadMoreBtn.style.display = records.length > paginated.length ? 'block' : 'none';
                } catch (error) {
                    console.error('渲染记录列表失败:', error);
                    recordsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">加载失败</div>';
                }
            }

            async updateCategoryFilter() {
                const categoryFilter = document.getElementById('categoryFilter');
                
                try {
                    const records = await this.db.getRecords();
                    const categories = [...new Set(records.map(r => r.category))];
                    
                    categoryFilter.innerHTML = '<option value="">全部分类</option>' + 
                        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                } catch (error) {
                    console.error('更新分类筛选器失败:', error);
                }
            }

            async applyFilters() {
                this.currentFilters = {
                    type: document.getElementById('typeFilter').value,
                    category: document.getElementById('categoryFilter').value,
                    startDate: document.getElementById('dateFilterStart').value,
                    endDate: document.getElementById('dateFilterEnd').value
                };
                
                this.recordsPage = 1;
                await this.renderRecords();
                document.getElementById('filterPanel').classList.remove('show');
                this.showToast('筛选已应用');
            }

            updateTime() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                document.getElementById('currentTime').textContent = `${hours}:${minutes}`;
                
                const month = now.getMonth() + 1;
                const year = now.getFullYear();
                document.getElementById('currentMonth').textContent = `${year}年${month}月`;
            }

            // ============ 分类管理功能 ============
            async openCategoryModal() {
                document.getElementById('categoryModal').classList.add('show');
                await this.renderCategoryManageList();
                this.renderIconSelector();
                this.resetCategoryForm();
            }

            async renderCategoryManageList() {
                const list = document.getElementById('categoryManageList');
                
                try {
                    const categories = this.db.categories[this.currentCategoryTab];
                    const customCats = this.db.customCategories[this.currentCategoryTab];
                    
                    list.innerHTML = categories.map(cat => {
                        const isCustom = customCats.some(cc => cc.name === cat.name);
                        
                        return `
                            <div class="category-item ${!isCustom ? 'system' : ''}">
                                <div class="category-item-info">
                                    <div class="category-item-icon">
                                        <i class="fas ${cat.icon}"></i>
                                    </div>
                                    <div class="category-item-details">
                                        <h4>${cat.name}</h4>
                                        <p>${!isCustom ? '系统分类' : '自定义分类'}</p>
                                    </div>
                                </div>
                                ${isCustom ? `
                                    <button class="delete-category-btn" 
                                            onclick="app.confirmDeleteCategory('${this.currentCategoryTab}', '${cat.name}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('渲染分类管理列表失败:', error);
                    list.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">加载失败</div>';
                }
            }

            renderIconSelector() {
                const icons = [
                    'fa-shopping-cart', 'fa-apple-alt', 'fa-pizza-slice', 'fa-coffee',
                    'fa-tshirt', 'fa-mobile-alt', 'fa-laptop', 'fa-book',
                    'fa-gamepad', 'fa-film', 'fa-music', 'fa-camera',
                    'fa-plane', 'fa-car', 'fa-bus', 'fa-subway',
                    'fa-heart', 'fa-medkit', 'fa-dumbbell', 'fa-cut',
                    'fa-home', 'fa-wifi', 'fa-lightbulb', 'fa-faucet',
                    'fa-gift', 'fa-donate', 'fa-hand-holding-usd', 'fa-piggy-bank',
                    'fa-graduation-cap', 'fa-tools', 'fa-pencil-ruler', 'fa-baby',
                    'fa-paw', 'fa-couch', 'fa-gas-pump', 'fa-credit-card',
                    'fa-chart-line', 'fa-briefcase', 'fa-handshake', 'fa-rocket'
                ];

                const selector = document.getElementById('iconSelector');
                selector.innerHTML = icons.map(icon => `
                    <div class="icon-option" data-icon="${icon}">
                        <i class="fas ${icon}"></i>
                    </div>
                `).join('');
                
                const firstIcon = selector.querySelector('.icon-option');
                if (firstIcon) {
                    firstIcon.classList.add('selected');
                    this.selectedIcon = firstIcon.dataset.icon;
                }
                
                this.bindIconSelector();
            }

            bindIconSelector() {
                const iconOptions = document.querySelectorAll('.icon-option');
                iconOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        iconOptions.forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        this.selectedIcon = option.dataset.icon;
                        this.validateCategoryInput();
                    });
                });
            }

            async addCustomCategory() {
                const nameInput = document.getElementById('newCategoryName');
                const name = nameInput.value.trim();
                
                if (!name) {
                    this.showToast('请输入分类名称');
                    return;
                }
                
                try {
                    const result = await this.db.addCustomCategory(this.currentCategoryTab, name, this.selectedIcon);
                    if (result.success) {
                        this.resetCategoryForm();
                        await this.renderCategoryManageList();
                        this.renderCategories();
                        this.showToast('分类添加成功！');
                    } else {
                        this.showToast(result.message);
                    }
                } catch (error) {
                    console.error('添加分类失败:', error);
                    this.showToast('添加分类失败');
                }
            }

            async confirmDeleteCategory(type, name) {
                if (confirm(`确定要删除分类"${name}"吗？删除后不可恢复。`)) {
                    try {
                        const result = await this.db.deleteCustomCategory(type, name);
                        if (result.success) {
                            await this.renderCategoryManageList();
                            this.renderCategories();
                            this.showToast('分类删除成功！');
                        } else {
                            this.showToast(result.message);
                        }
                    } catch (error) {
                        console.error('删除分类失败:', error);
                        this.showToast('删除分类失败');
                    }
                }
            }

            validateCategoryInput() {
                const nameInput = document.getElementById('newCategoryName');
                const addBtn = document.getElementById('addCategoryBtn');
                const name = nameInput.value.trim();
                
                if (!name) {
                    addBtn.disabled = true;
                    return;
                }
                
                const exists = this.db.categories[this.currentCategoryTab].some(c => c.name === name);
                addBtn.disabled = exists;
                
                nameInput.style.borderColor = exists ? '#ef4444' : '#e2e8f0';
            }

            resetCategoryForm() {
                document.getElementById('newCategoryName').value = '';
                document.getElementById('newCategoryName').style.borderColor = '#e2e8f0';
                document.getElementById('addCategoryBtn').disabled = true;
                this.renderIconSelector();
            }

            closeModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('show');
                });
                
                const importInput = document.getElementById('importFileInput');
                if (importInput) importInput.value = '';
                const confirmImportBtn = document.getElementById('confirmImport');
                if (confirmImportBtn) confirmImportBtn.disabled = true;
                
                document.getElementById('customDateRange').classList.remove('show');
                
                // 重置编辑和删除状态
                this.db.editingRecordId = null;
                this.db.deletingRecordId = null;
            }

            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2500);
            }

            showLoading(show) {
                const loading = document.getElementById('loadingOverlay');
                loading.classList.toggle('show', show);
            }
        }

        // ============ 初始化应用 ============
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new AccountingApp();
        });
    </script>
</body>
</html>
